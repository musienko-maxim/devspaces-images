======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 5206d664642
STEP 3/23: ARG BOOTSTRAP=true
--> 5cb3360e00a
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> c569113bfc4
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 57bb134b77c
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 0679e95845c
STEP 7/23: ARG ALLOWED_TAGS=""
--> cc48df04918
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> f0abe33e17b
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> da4b05faa02
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 80739ec7b08
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.x86_64                       
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.x86_64             
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.x86_64                
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.x86_64                        
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.x86_64                  
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.x86_64                   
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.x86_64                                                       
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.x86_64                 
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.x86_64                              
  fuse-common-3.3.0-16.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.x86_64                     
  fuse3-3.3.0-16.el8.x86_64                                                     
  fuse3-libs-3.3.0-16.el8.x86_64                                                
  iptables-libs-1.8.4-23.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-41.0-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.x86_64                         
  nftables-1:0.9.3-26.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.x86_64                           
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.x86_64                         
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Installing collected packages: PyYAML, xmltodict, argcomplete, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> 8a12eda7abe
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 054501cfb85
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> e0b82f9f8ab
STEP 14/23: COPY ./VERSION /
--> 52d646faf87
STEP 15/23: COPY ./devfiles /build/devfiles
--> 99e031b9780
STEP 16/23: WORKDIR /build/
--> b71e2d00832
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 183 contributors and audited 120 packages in 19.371s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 4.044s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 37ae269ed03
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 9dd5a710a98
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - 3.4 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> ca25a6d94fb
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_dotnet/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 606dae8c797
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 9c250844622
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 6c6926b3a78
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 5b66f8f2759
Successfully tagged localhost/devfileregistry:tmp
5b66f8f2759ee84148640f44b2346ab17f3ce11825050069d17b0bb5edcbe5e6
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r /tmp/tmp.icW2Rwz21E/devfiles/04_nodejs-mongo/devworkspace-che-theia-latest.yaml /tmp/tmp.td4fcEgOyl/devfiles/04_nodejs-mongo/devworkspace-che-theia-latest.yaml
--- /tmp/tmp.icW2Rwz21E/devfiles/04_nodejs-mongo/devworkspace-che-theia-latest.yaml	2022-12-19 11:05:37.000000000 -0500
+++ /tmp/tmp.td4fcEgOyl/devfiles/04_nodejs-mongo/devworkspace-che-theia-latest.yaml	2022-12-19 12:51:40.227709813 -0500
@@ -182,8 +182,6 @@
         attributes:
           che-theia.eclipse.org/vscode-extensions:
             - >-
-              relative:extension/resources/github_com/redhat-developer/devspaces-vscode-extensions/releases/download/v2cebc1e/typescript-language-features-1.49.3.vsix
-            - >-
               relative:extension/resources/open-vsx_org/api/ms-vscode/js-debug/1_66_0/file/ms-vscode.js-debug-1.66.0.vsix
             - >-
               relative:extension/resources/github_com/fabric8-analytics/fabric8-analytics-vscode-extension/releases/download/0_3_6/fabric8-analytics-0.3.6.vsix
diff --suppress-common-lines -u -r /tmp/tmp.icW2Rwz21E/devfiles/04_nodejs-simple/devworkspace-che-theia-latest.yaml /tmp/tmp.td4fcEgOyl/devfiles/04_nodejs-simple/devworkspace-che-theia-latest.yaml
--- /tmp/tmp.icW2Rwz21E/devfiles/04_nodejs-simple/devworkspace-che-theia-latest.yaml	2022-12-19 11:05:37.000000000 -0500
+++ /tmp/tmp.td4fcEgOyl/devfiles/04_nodejs-simple/devworkspace-che-theia-latest.yaml	2022-12-19 12:51:40.227709813 -0500
@@ -179,8 +179,6 @@
         attributes:
           che-theia.eclipse.org/vscode-extensions:
             - >-
-              relative:extension/resources/github_com/redhat-developer/devspaces-vscode-extensions/releases/download/v2cebc1e/typescript-language-features-1.49.3.vsix
-            - >-
               relative:extension/resources/open-vsx_org/api/ms-vscode/js-debug/1_66_0/file/ms-vscode.js-debug-1.66.0.vsix
             - >-
               relative:extension/resources/github_com/fabric8-analytics/fabric8-analytics-vscode-extension/releases/download/0_3_6/fabric8-analytics-0.3.6.vsix
Binary files /tmp/tmp.icW2Rwz21E/resources/v2/nodejs-mongodb-sample.zip and /tmp/tmp.td4fcEgOyl/resources/v2/nodejs-mongodb-sample.zip differ
Binary files /tmp/tmp.icW2Rwz21E/resources/v2/web-nodejs-sample.zip and /tmp/tmp.td4fcEgOyl/resources/v2/web-nodejs-sample.zip differ
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 5b66f8f2759ee84148640f44b2346ab17f3ce11825050069d17b0bb5edcbe5e6
Deleted: 6c6926b3a78c39a3b0a5ac0604b2b14908c8ccef774323f52c3212de9500fab3
Deleted: 9c2508446224f994717ec486c024e16e7d105319ff986599cbdc95d5175a72e0
Deleted: 606dae8c7977fa65e35a9cb4e9d336abfa5fdeb3db04a957bbd41da31f6345c6
Deleted: ca25a6d94fb7851e764d376023b86726be8e46ace55d6476554e8c9d7b773aa6
Deleted: 9dd5a710a98362d4ffd2710712b5121ee34346dd17a202ee90cafd363a7df8b3
Deleted: 37ae269ed0354afce006a6368bd379c3b4f6b1b85bba3fc5005ebe00ea0c011e
Deleted: b71e2d00832cddec4bb72e1a2b15cac31f0d33b2fb725117b05e35517de2ca11
Deleted: 99e031b9780e1fd78f161292742a4627d0bd999fc39be8157003cddda7289aaa
Deleted: 52d646faf8704c5e42c3db3f471faaa9073397159cfb96f8762e535f877cb948
Deleted: e0b82f9f8abd6579fd805ae7fae97f2706bd8e03b8fce6914b81b1796c0232b8
Deleted: 054501cfb851c361cf0ae271954e39c010080fa9f30a36d63d0632dc42a31e50
Deleted: 8a12eda7abef7de7263350e10d1f05efeaa50d947b34205cdb83a0a2831e13e0
Deleted: 80739ec7b08c4f84ad8f3704fde713102a18574d66b133afc9848445ca3c3aa5
Deleted: da4b05faa0232124fe5b3c377f25e9fdc708e8f346469509f54dbf05eb15f734
Deleted: f0abe33e17bc98fdceaed017bb9d1639dfd4d7e2a420d1f080978489899e4b82
Deleted: cc48df0491836a07737863fe3b4485b2bf2a21f3f5ff15efd295acbf9258b7ad
Deleted: 0679e95845cc073c50bfb410c0edbcbfea7f196ef9b9f8329aabe9e00909e48b
Deleted: 57bb134b77c65d71846b64ad85bb2e557f65cdf165aef6390824ccbae6ed58aa
Deleted: c569113bfc44b5cfa4f0103be38befe6e6f556957a0e09c15d928af1be2d0c39
Deleted: 5cb3360e00abd0c390bc59635e0e781f62ed01ff164155dbecc9f86de862b284
Deleted: 5206d66464232a525cb15ba493af6ac500b966208c39d83114e25a28ccbbeb8c
File already uploaded: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
