======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 8e0c3ac0dd8
STEP 3/23: ARG BOOTSTRAP=true
--> 633233bf305
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 56208737687
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 360fba7fd20
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 9d6aa20a04e
STEP 7/23: ARG ALLOWED_TAGS=""
--> 1364971e0ba
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 6d231bbf77c
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> f101c3d495a
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> d38aebe70b5
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.x86_64                       
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.x86_64             
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.x86_64                
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.x86_64                        
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.x86_64                  
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.x86_64                   
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.x86_64                                                       
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.x86_64                 
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.x86_64                              
  fuse-common-3.3.0-16.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.x86_64                     
  fuse3-3.3.0-16.el8.x86_64                                                     
  fuse3-libs-3.3.0-16.el8.x86_64                                                
  iptables-libs-1.8.4-23.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-41.0-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.x86_64                         
  nftables-1:0.9.3-26.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.x86_64                           
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.x86_64                         
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Installing collected packages: toml, xmltodict, argcomplete, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> fa84880f63f
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> a55c17a5271
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 737bc2247c2
STEP 14/23: COPY ./VERSION /
--> 474606800d3
STEP 15/23: COPY ./devfiles /build/devfiles
--> 91b9047f6a4
STEP 16/23: WORKDIR /build/
--> 131b4e32301
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 183 contributors and audited 120 packages in 11.846s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 1.605s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 6ba6840a1d8
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 8b8e7dfd3ee
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - registry.redhat.io allowed
 + registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS - registry.redhat.io allowed
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - 3.4 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 6b33ed02f85
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/TP__cpp__c-plus-plus/meta.yaml'
Checking devfile 'devfiles/TP__dotnet__dotnet-web-simple/meta.yaml'
Checking devfile 'devfiles/TP__go__golang-health-check/meta.yaml'
Checking devfile 'devfiles/TP__php__php-hello-world/meta.yaml'
Checking devfile 'devfiles/java11-maven-lombok__lombok-project-sample/meta.yaml'
Checking devfile 'devfiles/java11-maven-quarkus__quarkus-quickstarts/meta.yaml'
Checking devfile 'devfiles/nodejs__nodejs-mongodb-sample/meta.yaml'
Checking devfile 'devfiles/nodejs__web-nodejs-sample/meta.yaml'
Checking devfile 'devfiles/python__python-hello-world/meta.yaml'
--> 12d811df39f
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> f17a4ada0df
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 6196d51fd74
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 417802d5c12
Successfully tagged localhost/devfileregistry:tmp
417802d5c122c43e220e41bf8fa28739cabbec6d37006ec332c408f1dce638b4
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
Binary files /tmp/tmp.Gykv4Lc1xU/resources/v2/php-hello-world.zip and /tmp/tmp.n8m8gLyLAW/resources/v2/php-hello-world.zip differ
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 417802d5c122c43e220e41bf8fa28739cabbec6d37006ec332c408f1dce638b4
Deleted: 6196d51fd7422aeee0c2d1fd9d570f6cb93ba16fc7859ce4c35ea75cb3ee9e79
Deleted: f17a4ada0df0a12375ddb213093d65462f64fce575afedcfa0ea624b29f5ced2
Deleted: 12d811df39f5474b69fdeaf6572e8afbcad7054e53d4c552c3fb0afb11a070ab
Deleted: 6b33ed02f85a2943060936f18b93d1b2c9c91978149320bb0499d87f864dc3b1
Deleted: 8b8e7dfd3ee9200de61e47a5d436a40df2a44ae6a72e5f060bd8a0068eec581d
Deleted: 6ba6840a1d854f7a5674603ea4b461bcb81e7d773ba7f29696fcba6b6436adb8
Deleted: 131b4e32301ef2ffbe7f8825231c2aaf446441dc0b759f05bd2e8c1a732b872a
Deleted: 91b9047f6a4453aa10395924832938842427e8050686ab767b398759322a4c57
Deleted: 474606800d3c25d48fd60e6412f122c0ebb8d3712227f943ac6634d8ffa720b0
Deleted: 737bc2247c2959afc4da2c8ee160b7ebfde1efa9504e1bf5e698214ff719d04a
Deleted: a55c17a5271be94713ef9f4959775ef6ade80636f87c344abbc3ba4920f97429
Deleted: fa84880f63f6465f596d20161e0a30ca765437133f68b4c8bf0e0c815ec58cf2
Deleted: d38aebe70b541c246f2a7a1e39c4e8682f07443e4fe16cecf66efe4c66bf0196
Deleted: f101c3d495a123bfb4144d5bdd6616d07edd9582b818d3e0de92a372bd0d1156
Deleted: 6d231bbf77c823089b919fedb4795a8c80db25339be3068fb72e96678d629d62
Deleted: 1364971e0ba24879670188b2efb1fbddadf9bdb68e706b51da808abe2f737eb8
Deleted: 9d6aa20a04e9e4fe2a0fef6649497ce3148b309c6a628318dc61ef912505df35
Deleted: 360fba7fd20ba0fc889cb7e8a1b9066d2d70433bd4e0051272c53aab2eca8861
Deleted: 5620873768789398d4181febca31182c89312955c78334aa9b1d9353e572de63
Deleted: 633233bf305b55069a2222a699ecabc555307e2c7659c0cd90373002ccd06ccc
Deleted: 8e0c3ac0dd8eddeb9fb3d18d4743f10de0c22ab05603bc583ec677350a1026a2
File already uploaded: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
